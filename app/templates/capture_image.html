<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>La noche europea de los investigadores</title>
    <link rel="stylesheet" href="/static/css/capture_image_styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/plugins/sweetAlert2/sweetalert2.min.css">
</head>

<body>
    <p id="url" class="oculto">{{ server_gpu_url }}</p>
    <p id="publicKey" class="oculto">{{ pub_key_server_gpu }}</p>

    <script src="https://code.jquery.com/jquery-1.8.3.min.js"></script>
    <script src="https://passport.cnblogs.com/scripts/jsencrypt.min.js"></script>

    <script type="text/javascript">
        function isVisible(element) {
            return element.offsetWidth > 0 || element.offsetHeight > 0;
        }

        function obtenerCanvas() {
            var canvasLaptop = document.getElementById('canvasLaptop');
            var canvasTabletVertical = document.getElementById('canvasTabletVertical');
            var canvasTabletHorizontal = document.getElementById('canvasTabletHorizontal');
            var canvasMovil = document.getElementById('canvasMovil');

            if (isVisible(canvasLaptop)) {
                return 'canvasLaptop';
            }
            if (isVisible(canvasTabletVertical)) {
                return 'canvasTabletVertical';
            }
            if (isVisible(canvasTabletHorizontal)) {
                return 'canvasTabletHorizontal';
            }
            if (isVisible(canvasMovil)) {
                return 'canvasMovil';
            }
        }

        function snapPhoto() {
            var canvas = document.getElementById(obtenerCanvas());
            var context = canvas.getContext('2d');
            var video = document.getElementById('video');
            var relacion = 1.33;

            var videoHeight = video.clientWidth / relacion;
            var inicioHeight = (video.clientHeight - videoHeight) / 2;
            context.drawImage(video, 0, inicioHeight, video.clientWidth, videoHeight);

            document.getElementById('send_button').style.display = 'block';
        }

        function sendPhoto() {
            Swal.fire({
                title: '¿Deseas enviar esta foto?',
                text: "¡No podrás revertir tu decisión!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#00FF24',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Enviar',
                cancelButtonText: 'No enviar'
            }).then((result) => {
                if (result.isConfirmed) {
                    var url = document.getElementById('url').innerText;

                    if (url == '') {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error de conexión...',
                            text: 'El servidor GPU no está disponible en este momento.'
                        });
                    } else {
                        url = url + '/deduct';

                        var publicKey = document.getElementById('publicKey').innerText;
                        publicKey = publicKey.replace(/RSA /g, "");

                        /*
                        var uint8arrayToString = function(data) {
                            return String.fromCharCode.apply(null, data);
                        };

                        const spawn = require('child_process').spawn;

                        const scriptExecution = spawn("python", ["encrypt.py", publicKey]);

                        // Manejo normal del output
                        scriptExecution.stdout.on('data', (data) => {
                            console.log(uint8arrayToString(data));
                        });
                        */


                        var encrypt = new JSEncrypt();



                        console.log(publicKey)

                        encrypt.setPublicKey(publicKey);


                        var canvas = document.getElementById(obtenerCanvas());
                        var imgBase64 = canvas.toDataURL("image/jpeg", 1.0);

                        var encrypted = encrypt.encrypt(imgBase64);

                        console.log(imgBase64)
                        console.log(publicKey)
                        console.log(encrypted)

                        const Http = new XMLHttpRequest();
                        Http.open("POST", url, true);
                        Http.setRequestHeader("Content-Type", "application/json");

                        Http.onreadystatechange = function() {
                            var age = Http.responseText
                            console.log(age)

                            window.location.replace('./interface_' + age);
                        };

                        var data = {
                            imagen: imgBase64
                        }

                        Http.send(JSON.stringify(data));
                    }
                }
            });
        }
    </script>

    <header class="header">
        <nav class="nav__header">
            <div class="container nav__container">
                <div class="logo">
                    <h2 class="logo__name">La noche europea de los investigadores <span class="siglas">(ERN)</span></h2>
                </div>
                <div class="tools">
                    <div class="show_links links">
                        <a href="./" class="link">Inicio</a>
                        <a href="#" class="link__active">Sobre nosotros</a>
                    </div>
                    <button class="switch_dark_mode" id="switch_dark_mode">
                        <img src="/static/img/sun-solid.svg" class="icono icono_sun">
                        <img src="/static/img/moon-solid.svg" class="icono icono_moon">
                    </button>
                    <button class="show_sidebar button_sidebar" id="button_sidebar">
                        <img src="/static/img/bars-solid.svg" class="bars-solid">
                    </button>
                </div>
            </div>
        </nav>

        <section class="container__header__main__capture">
            <div>
                <div class="cont_video">
                    <video id="video" class="video" playsinline autoplay></video>
                </div>

                <div class="capture_button">
                    <div id="snap" class="enlace" onclick="snapPhoto()">
                        <img src="/static/img/camera-solid.svg" class="icono message-solid">
                        <div class="button">Capturar</div>
                    </div>
                </div>
            </div>

            <div class="sidebar" id="sidebar">
                <div class="sidebar_content">
                    <a href="./" class="link_lateral">Inicio</a>
                    <a href="#" class="link_lateral__active">Sobre nosotros</a>
                </div>
            </div>

        </section>
    </header>

    <main>
        <section id="visualizar" class="visualizar">
            <div class="container__header__main__capture">
                <div>
                    <section class="cont_video">
                        <canvas id="canvasLaptop" class="canvasLaptop" width="830" height="624"></canvas>
                        <canvas id="canvasTabletVertical" class="canvasTabletVertical" width="450" height="338"></canvas>
                        <canvas id="canvasTabletHorizontal" class="canvasTabletHorizontal" width="547" height="411"></canvas>
                        <canvas id="canvasMovil" class="canvasMovil" width="180" height="135"></canvas>
                    </section>

                    <div id="send_button" class="send_button">
                        <div id="send" class="enlace" onclick="sendPhoto()">
                            <img src="/static/img/paper-plane-solid.svg" class="icono message-solid">
                            <div class="button">Enviar</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script src="/static/plugins/sweetAlert2/sweetalert2.all.min.js"></script>
    <script src="/static/js/capture_image.js"></script>
</body>

</html>